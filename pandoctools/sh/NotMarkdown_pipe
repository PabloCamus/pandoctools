#!/bin/bash
export KNITTY=True

_ipynb=()
if [[ "${out_ext}" == "ipynb" ]]; then
    _ipynb=("--to-ipynb"); fi

pandoc "${reader_args[@]}" -t markdown |
cat-md stdin "$metadata" "${extra_inputs[@]}" |
pandoc -f markdown -t json |
knitty "${input_file}" "${reader_args[@]}" "${writer_args[@]}" "${_ipynb[@]}" |
panfl "${panfl_args[@]}" |
pandoc-crossref "$t" |
pandoc -f json "${writer_args[@]}" |
if [[ "${out_ext}" == "ipynb" ]]; then
    post-knitty --to-ipynb |
    jupyter nbconvert "${nbconvert_args[@]}"
elif [[ "$to" == "html" && "${out_ext}" == "pdf" ]]; then
    python "$mathjax" sub_pdf "${mathjax_url}" |
    pyppdf -o "${output_file}" --goto temp
elif [[ "${to:0:4}" == "html" ]]; then
    python "$mathjax" sub
else
    cat; fi

if [[ -d "$tmpdir" ]]; then rm -rf "$tmpdir"; fi
